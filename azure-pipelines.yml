# ===============================
# Azure DevOps Pipeline for APFM
# 빌드 → ACR 푸시 → AKS 배포 (kubectl + kubeconfig 주입)
# Windows Self-hosted Agent 버전
# ===============================

trigger:
- main

resources:
- repo: self

variables:
  dockerRegistryServiceConnection: '05c23959-ace4-4487-a73b-d09fe638aff7'  # ✅ ACR 로그인용
  containerRegistry: 'apfmrg.azurecr.io'
  imagePullSecret: 'apfmrgf81e-auth'
  namespace: 'apfm'

stages:
# =========================
# Build Stage
# =========================
- stage: Build
  displayName: Build stage
  jobs:
  - job: Build_Backend
    displayName: Build Backend
    pool:
      name: Default          # ✅ Self-hosted agent pool
    steps:
    - task: Docker@2
      displayName: Build and push Backend image
      inputs:
        command: buildAndPush
        repository: backend
        dockerfile: backend/Dockerfile
        buildContext: backend
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: latest

  - job: Build_Frontend
    displayName: Build Frontend
    pool:
      name: Default
    steps:
    - task: Docker@2
      displayName: Build and push Frontend image
      inputs:
        command: buildAndPush
        repository: frontend
        dockerfile: front/Dockerfile
        buildContext: front
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: latest

  # FastAPI 빌드가 필요하면 주석 해제
  # - job: Build_FastAPI
  #   displayName: Build FastAPI
  #   pool:
  #     name: Default
  #   steps:
  #   - task: Docker@2
  #     displayName: Build and push FastAPI image
  #     inputs:
  #       command: buildAndPush
  #       repository: fastapi
  #       dockerfile: AI/Dockerfile
  #       buildContext: AI
  #       containerRegistry: $(dockerRegistryServiceConnection)
  #       tags: latest

# =========================
# Deploy Stage
# =========================
- stage: Deploy
  displayName: Deploy stage
  dependsOn: Build
  jobs:
  - deployment: Deploy_to_K8s
    displayName: Deploy to Kubernetes
    environment: 'apfm-aks'
    pool:
      name: Default
    strategy:
      runOnce:
        deploy:
          steps:
          # 1️⃣ kubeconfig 파일 생성 (Library 변수에 KUBECONFIG_CONTENT 등록 필요)
          - powershell: |
              Write-Output "Setting up kubeconfig..."
              Set-Content -Path "./kubeconfig.yaml" -Value "$(KUBECONFIG_CONTENT)"
              $env:KUBECONFIG = "$(System.DefaultWorkingDirectory)\kubeconfig.yaml"
              kubectl get nodes
            displayName: "Setup kubeconfig"

          # 2️⃣ backend-secrets 생성/갱신 (PowerShell Here-String)
          - powershell: |
              Write-Output "Creating backend secrets..."
              $secret = @"
              apiVersion: v1
              kind: Secret
              metadata:
                name: backend-secrets
                namespace: $(namespace)
              type: Opaque
              stringData:
                SECRET_KEY: $(SECRET_KEY)
                ADMIN_EMAIL: $(ADMIN_EMAIL)
                ADMIN_PASSWORD: $(ADMIN_PASSWORD)
                REDIS_PASSWORD: $(REDIS_PASSWORD)
                ACCOUNT_KEY: $(ACCOUNT_KEY)
                CONNECTION_STRING: $(CONNECTION_STRING)
                CONTAINER_NAME: $(CONTAINER_NAME)
                MAIL_USERNAME: $(MAIL_USERNAME)
                MAIL_PASSWORD: $(MAIL_PASSWORD)
              "@
              $secret | kubectl apply -f -
            displayName: "Create/Update backend secrets"

          # 3️⃣ Deployment/Service 배포
          - powershell: |
              kubectl apply -f k8s/backend-deploy.yaml -n $(namespace)
              kubectl apply -f k8s/frontend-deploy.yaml -n $(namespace)
              kubectl apply -f k8s/fastapi-deploy.yaml -n $(namespace)
              kubectl apply -f k8s/nginx-deploy.yaml -n $(namespace)
            displayName: "Apply manifests"
