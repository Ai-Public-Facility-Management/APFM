import requests

# ========== 1. 먼저 제안서 텍스트 생성 ==========
generate_url = 'http://localhost:8080/generate-proposal'

# 실제 견적 데이터 예시 (간단 버전, 실제는 vision_analysis, output_text 등 포함)
estimations = [
    {
        "vision_analysis": "이 이미지에서는 도로변 안전 시설물인 가드레일의 상태를 확인할 수 있습니다. 내용은 다음과 같습니다:\n\n- **탐지된 시설물**: 차량 추돌 방지를 위한 가드레일.\n- **시설물 상태**: 중간 구간(약 5m)이 심하게 휘어져 있으며 일부 부속품이 분실됨.\n- **면적**: 파손 구간은 도로 폭 기준 5m이며, 인접 구간은 정상 상태.\n- **주변 환경**: 차량 통행량이 많은 도로 구간으로 시공 시 교통 통제 필요.\n\n이 정보들을 바탕으로 견적 산출에 필요할 수 있는 복구 작업 및 교체 비용을 계산할 수 있습니다.",
        "output_text": "예상 견적 (원): 3,500,000원\n\n📌 계산 근거 요약:\n- 가드레일 복구 작업: 가드레일 설치 기준에 따라 특별 인부 3명이 필요하며, 시공 구간은 5m로 가정.\n- 인건비: 특별 인부 일당 150,000원으로 가정.\n- 장비비: 절단기 및 용접기 사용 비용은 인건비의 8%로 추가.\n- 자재비: 가드레일 및 부속 자재 비용 1,500,000원 포함.\n\n📚 참고 문서 내용 요약:\n- 가드레일 복구에는 절단기 및 용접기 사용이 필수이며, 설치 규격에 맞춘 자재비가 필요함.\n- 시공 시 차량 통행이 많은 도로 환경에 따라 안전 관리 인력 추가 배치 필요.\n- 도로점용 허가 절차를 사전에 완료해야 함.\n\n이 견적은 문서에서 제공된 가드레일 시공 기준과 현장 안전 관리 요구사항을 반영하여 산출하였습니다."
    },
    {
        "vision_analysis": "이 이미지에서는 보도블럭 포장의 상태를 확인할 수 있습니다. 내용은 다음과 같습니다:\n\n- **탐지된 시설물**: 인도 보행로를 구성하는 보도블럭.\n- **시설물 상태**: 일부 블럭이 깨지거나 들떠 있으며, 보행자 안전에 위험 요인 존재.\n- **면적**: 보수 대상 면적은 약 10㎡로 추정.\n- **보행 공간 상태**: 해당 구간 외에는 보행에 지장이 없음.\n\n이 정보들을 바탕으로 견적 산출에 필요할 수 있는 보도블럭 교체 비용을 계산할 수 있습니다.",
        "output_text": "예상 견적 (원): 2,800,000원\n\n📌 계산 근거 요약:\n- 보도블럭 교체 작업: 시공 면적 10㎡로 가정하며, 보통 인부 2명이 필요.\n- 인건비: 보통 인부 일당 100,000원으로 가정.\n- 장비비: 절단기 및 소형 운반차 사용 비용은 인건비의 5%로 추가.\n- 자재비: 보도블럭 및 기초재 자재비 1,500,000원 포함.\n\n📚 참고 문서 내용 요약:\n- 보도블럭 교체 시 기초 시공 품질 확보를 위해 적정한 다짐 공정 필요.\n- 도보 통행이 유지되도록 작업 구간을 분할 시공.\n- 폐기물 처리는 관련 법규에 따라 처리해야 함.\n\n이 견적은 문서에서 제시한 보도블럭 시공 기준과 일반적인 도심지 보행 환경을 고려하여 산출하였습니다."
    },
    {
        "vision_analysis": "이 이미지에서는 교통 안내 표지판의 상태를 확인할 수 있습니다. 내용은 다음과 같습니다:\n\n- **탐지된 시설물**: 도로변 교통 안내 표지판.\n- **시설물 상태**: 표지판 표면에 페인트 벗겨짐과 오염이 심하며 기초 부식이 진행됨.\n- **면적**: 표지판 규격은 8㎡ 이하이며, 1개소 기준.\n- **주변 환경**: 차량 속도가 빠른 도로 구간으로, 시공 시 안전 통제 필요.\n\n이 정보들을 바탕으로 견적 산출에 필요할 수 있는 표지판 교체 비용을 계산할 수 있습니다.",
        "output_text": "예상 견적 (원): 1,800,000원\n\n📌 계산 근거 요약:\n- 표지판 설치 작업: 표지판 규격 8㎡ 이하, 1개소 설치 기준.\n- 인건비: 특별 인부 1명과 보통 인부 1명, 일당 각각 150,000원, 100,000원으로 가정.\n- 장비비: 크레인(5톤) 사용 비용은 인건비의 10%로 추가.\n- 자재비: 표지판, 기초재, 부속 자재비 800,000원 포함.\n\n📚 참고 문서 내용 요약:\n- 표지판 설치에는 안전 확보를 위한 크레인 작업과 지반 기초 시공이 필수.\n- 도로 교통 통제 계획을 사전에 수립해야 함.\n- 설치 후 반사도 및 시인성 검사를 실시해야 함.\n\n이 견적은 문서에서 제공된 표지판 설치 기준과 안전 시공 절차를 반영하여 산출하였습니다."
    }
]

payload = {
    "estimations": estimations,
}

resp = requests.post(generate_url, json=payload)
resp.raise_for_status()
proposal_json = resp.json()
print("=== 제안서 텍스트(JSON) ===")
print(proposal_json)

# ========== 2. 생성된 proposal을 워드 파일로 변환 ==========
docx_url = 'http://localhost:8080/proposal-to-docx'

# proposal-json에서 proposal 부분만 추출해서 보냄
docx_payload = {
    "proposal": proposal_json["proposal"]
}

docx_resp = requests.post(docx_url, json=docx_payload)
docx_resp.raise_for_status()

with open("test_proposal.docx", "wb") as f:
    f.write(docx_resp.content)

print("워드 파일이 test_proposal.docx로 저장되었습니다.")
